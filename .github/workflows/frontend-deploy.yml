name: Frontend Deploy

on:
  push:
    branches: [main, sandbox, frontend-stable]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'next.config.js'
      - 'tailwind.config.js'
      - 'tsconfig.json'
  pull_request:
    branches: [main, sandbox]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - 'next.config.js'
      - 'tailwind.config.js'
      - 'tsconfig.json'

env:
  NODE_VERSION: '18'

jobs:
  # Job de validaci√≥n del frontend
  validate-frontend:
    name: Validar Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Instalar dependencias
        run: npm ci
        
      - name: Lint TypeScript
        run: npx tsc --noEmit
        
      - name: Lint c√≥digo
        run: npx eslint src/ --ext .ts,.tsx --max-warnings 0
        
      - name: Build del frontend
        run: npm run build
        
      - name: Verificar build
        run: |
          echo "üîç Verificando build del frontend..."
          ls -la .next/
          echo "‚úÖ Build del frontend exitoso"

  # Job de deploy a sandbox (Amplify)
  deploy-sandbox-frontend:
    name: Deploy Frontend a Sandbox
    runs-on: ubuntu-latest
    needs: validate-frontend
    if: |
      github.ref == 'refs/heads/sandbox' || 
      github.ref == 'refs/heads/frontend-stable' ||
      contains(github.event.head_commit.message, '[deploy-frontend]')
    
    environment: sandbox-frontend
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Instalar dependencias
        run: npm ci
        
      - name: Build para sandbox
        run: |
          echo "üèóÔ∏è Building para sandbox..."
          npm run build
          
      - name: Notificar deploy a sandbox
        run: |
          echo "‚úÖ Frontend listo para deploy a sandbox"
          echo "üåê Amplify se encargar√° del deploy autom√°tico"

  # Job de deploy a producci√≥n (Amplify)
  deploy-production-frontend:
    name: Deploy Frontend a Producci√≥n
    runs-on: ubuntu-latest
    needs: validate-frontend
    if: |
      github.ref == 'refs/heads/main' && 
      github.event_name == 'push' &&
      contains(github.event.head_commit.message, '[deploy-prod-frontend]')
    
    environment: production-frontend
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Instalar dependencias
        run: npm ci
        
      - name: Build para producci√≥n
        run: |
          echo "üèóÔ∏è Building para producci√≥n..."
          NODE_ENV=production npm run build
          
      - name: Notificar deploy a producci√≥n
        run: |
          echo "‚úÖ Frontend listo para deploy a producci√≥n"
          echo "üåê Amplify se encargar√° del deploy autom√°tico"
